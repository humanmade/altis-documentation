# Upgrading to v5

_If you are migrating from WordPress to Altis, check out the [migrating guide here](../migrating-from-wordpress.md) first._

To upgrade to Altis v5, edit your `composer.json` and change the version constraint for `altis/altis` and any local environment modules to `^5.0.0`:

```json
{
	"require": {
		"altis/altis": "^5.0.0"
	},
	"require-dev": {
		"altis/local-chassis": "^5.0.0",
		"altis/local-server": "^5.0.0"
	}
}
```

Next remove the `vendor` directory by running `rm -rf vendor` or on Windows `rmdir vendor`. You could also delete the directory using your code editor, finder or explorer.

**Note:** due to an issue in how Composer handles installation of `composer-plugin` packages the above step is required to ensure the new version of the required packages are used to manage the process.

Next run `composer update` to complete the upgrade. You should commit the updated `composer.json` and `composer.lock` files.

As Altis v5 requires infrastructure changes, [contact the Cloud team via the Dashboard support](support://new) when deploying v5 to an environment for the first time.

Lastly you will need to update your database tables using the CLI:

- On [Altis Dashboard](https://dashboard.altis-dxp.com/) find the stack you have deployed to and run `core update-db --network` (`wp` is automatically prepended) in the WP CLI tab
- For Local Chassis run `composer chassis exec -- wp core update-db --network`
- For Local Server run `composer local-server cli -- core update-db --network`

If you use Local Chassis you will need to also update Chassis and its extensions by running `composer chassis upgrade`.


## Breaking Changes

### SEO

The AMP and Facebook Instant Articles plugins have been unbundled from Altis. This allows you to specify the versions of each directly in your Composer requirements. While these are no longer included with Altis, we plan to maintain compatibility with AMP in new features as necessary.

If you're using AMP in your project, after updating your Altis requirements, you will need to additionally require the AMP plugin:

```sh
$ composer require ampproject/amp-wp@1
```

Note that while Altis v4 bundles version 1 of the AMP plugin, version 2 is now available with [many major changes](https://github.com/ampproject/amp-wp/releases/tag/2.0.0), so consider updating at the same time.

If you're using Facebook Instant Articles, you will need to require the FBIA plugin. This requires first [adding WordPress Packagist as a repository](docs://getting-started/third-party-plugins#managing-plugins-via-composer), then requiring the plugin from wpackagist:

```sh
$ composer require wpackagist-plugin/fb-instant-articles
```


## Headline Features

### ElasticPress v3

Enhanced Search now includes version 3 of ElasticPress, which includes several major changes.

The most significant of the changes is the introduction of [Indexables](https://www.elasticpress.io/blog/2019/05/elasticpress-3-0-released/), which now allow other types of data to be indexed in Elasticsearch. The Post Indexable (which matches previous functionality), Term Indexable, and User Indexable are included by default. Custom indexables [can be built to allow searching other types of data](https://10up.github.io/ElasticPress/tutorial-indexables.html).

ElasticPress v3.4 includes many other new changes, including some internal changes, so consult the [EP changelog](https://github.com/10up/ElasticPress/releases) for details.

Altis v5 retains compatibility with existing code and indexes, but we recommend reading the EP release notes to see if you can use new features or adjust for minor changes. Note that minor adjustments have been made to default behaviour in ElasticPress, so consult the [Enhanced Search module documentation](docs://search) for further details on specifics.


### Better control over search

Altis 5 now includes the ability to specify custom user dictionaries used during the Elasticsearch indexing process. This allows setting custom synonyms and stopwords in the index. Crucially, this improves search indexing capabilities in languages without space-delimited words, such as Japanese. Dictionaries can be specified at the network or site level, allowing for detailed customization and configuration.

Fuzzy search can now be [configured](docs://search/search-configuration.md#fuzzy-matching). This allows tuning the allowed edit distance, prefix length, expansions and transpositions at a granular level to match desired behaviour.

Other changes included in the update to ElasticPress 3.4 also include the ability for users to adjust individual search queries, allowing results to be manually tuned or overridden, as well as better WooCommerce integration out of the box.

- Add support for ES packages humanmade/altis-local-chassis#102
- Add ability to register fields for autocompletion humanmade/altis-enhanced-search#92
- Add elasticpress integration for ajax queries humanmade/altis-enhanced-search#84


### WordPress 5.5

<!-- todo -->


### X-Ray
- Add docs for Xray humanmade/altis-cloud#205
- Exclude ALB healthchecks from X-ray humanmade/altis-cloud#243
- Send final filtered database query to X-Ray humanmade/altis-cloud#235


## Other Features and APIs

### Post Cloning

The CMS module now includes the ability to clone posts, including their full post data and post metadata. This behaviour can be modified via the [provided actions and filters](docs://cms/post-cloner.md).

### Post GUIDs

In order to set the groundwork for future import/export and migration tooling, GUIDs for post objects in Altis now use UUID URNs (e.g. `urn:uuid:d72fdc38-1305-4568-9821-463120b250f3`). This replaces the former URL-style GUIDs used for posts (e.g. `http://altis.local/?p=42`).

Due to legacy use of the GUID field, some older code may attempt to use the GUID for image media source URLs. This code must be updated to use `wp_get_attachment_url()` instead, which will also ensure that Tachyon and the Altis CDN are correctly used.

New code should only use the GUID field to uniquely identify posts, and never as a URL.

### Minimum version of the AWS SDK
- Upgrade minimum AWS SDK version 3.101.1 -> 3.150.0 humanmade/altis-core#89

### Multisite
- Replace WP blog signup notification humanmade/altis-cms#249
- Override sites list for better detail humanmade/altis-cms#243

### Dev Env
- Support XDebug on Linux humanmade/altis-local-server#185
- Fix db sequel command regression humanmade/altis-local-server#192

### Other Changes

Altis v5 includes many other small changes, consult the changelog for full details of all the changes shipped in this release.
